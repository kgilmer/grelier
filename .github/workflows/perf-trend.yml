name: Perf Trend
on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: perf-trend-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  trend:
    name: Collect And Publish Perf Trend
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps
        with:
          packages: libxkbcommon-dev libwayland-dev libudev-dev libpulse-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Configure cache
        uses: Swatinem/rust-cache@v2

      - name: Run performance benchmarks
        run: |
          CARGO_TERM_COLOR=never cargo bench --bench perf_gauges -- --output-format bencher \
            | tee benchmark-output.txt

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Gauge Performance
          tool: cargo
          output-file-path: benchmark-output.txt
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          gh-pages-branch: perf-data
          benchmark-data-dir-path: dev/bench
          max-items-in-chart: 100
